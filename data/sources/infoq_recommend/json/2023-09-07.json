[
  {
    "title": "降本增效：Grab如何在亚马逊云科技上将Kafka消费者流量成本降到零",
    "url": "https://www.infoq.cn/article/bHbaxQSIexCa63uzkJGl",
    "summary": "<p>Kafka 2.3引入了将Apache Kafka消费者连接到相同可用区域（AZ）代理节点的能力，Grab利用这一能力重新配置了消费者，<a href=\"https://engineering.grab.com/zero-traffic-cost\">将亚马逊云科技上的流量成本降低为零</a>\"。这一更改大大降低了在亚马逊云科技上运行Apache Kafka的基础设施总成本。</p><p>&nbsp;</p><p>Grab以Apache Kafka为中心创建了一个流数据平台，支撑公司所有的产品。遵循Kafka最佳实践，他们的初始配置为每个Kafka分区三个副本，横跨亚马逊云科技区域中三个不同的可用区。负责该平台的团队观察到，跨AZ流量占了他们Kafka平台一半的成本，因为<a href=\"https://aws.amazon.com/ec2/pricing/on-demand/#Data_Transfer_within_the_same_AWS_Region\">亚马逊云科技对跨AZ数据传输收费</a>\"。</p><p>&nbsp;</p><p>对于初始设置的成本，<a href=\"https://www.linkedin.com/in/fhcloud/\">Fabrice Harbulot</a>\"和<a href=\"https://www.linkedin.com/in/quangminhtran94/\">Quang Minh Tran</a>\"的看法如下：</p><p></p><blockquote>这种设计的问题在于，它会产生惊人的跨AZ网络流量。这是因为，在默认情况下，Kafka客户端只与分区leader通信，而分区leader有67%的概率驻留在不同的AZ中。</blockquote><p></p><p>&nbsp;</p><p>跨AZ流量包括新发布的消息、代理之间的数据复制和消费者获取的消息。</p><p></p><p><img src=\"https://static001.geekbang.org/infoq/28/28e5bb967e34b588ddf31b00dcdf2ea0.jpeg\" /></p><p></p><p>默认消费者配置，消费者从分区leader获取数据（图片来源：<a href=\"https://engineering.grab.com/zero-traffic-cost\">Grab工程博客</a>\"）</p><p>&nbsp;</p><p>从<a href=\"https://archive.apache.org/dist/kafka/2.3.0/RELEASE_NOTES.html\">Apache Kafka 2.3</a>\"开始，可以将消费者配置为从分区副本中获取数据了。这样，如果消费者只从同一AZ中的代理获取消息，就不会产生数据传输成本了。</p><p>&nbsp;</p><p>这个特性要求Kafka代理和消费者都知道其所在的AZ。对于Kafka代理，团队会使用AZ ID（az1、az2、az3等）配置broker.rack 。AZ ID与AZ名称（1a、1b、1c等）不同，因为<a href=\"https://docs.aws.amazon.com/ram/latest/userguide/working-with-az-ids.html\">AZ名称在亚马逊云科技账户间不一致</a>\"。他们还将参数replica.selector.class的值设置为org.apache.kafka.common.replica.RackAwareReplicaSelector。</p><p>&nbsp;</p><p>在消费者端，团队更新了内部Kafka SDK，基于EC2主机元数据用AZ ID配置client.rack 参数，为的是应用程序团队可以通过导出环境变量来启用该功能。</p><p></p><p><img src=\"https://static001.geekbang.org/infoq/98/9898f68a5854abb6c400ea677498a3f4.jpeg\" /></p><p></p><p>自定义消费者配置，消费者从最近的副本获取数据（图片来源：<a href=\"https://engineering.grab.com/zero-traffic-cost\">Grab工程博客</a>\"）</p><p>&nbsp;</p><p>在某些服务上应用新设置后，团队观察发现，跨AZ流量成本下降，并且有一些值得注意的副作用。首先，端到端延迟最多增加了500毫秒。考虑到大多数消费者从副本获取消息，这也是意料之中的。延迟增加是由复制时间导致的。理论上，任何对延迟敏感的数据流都应该始终从分区leader获取数据，即使那样会产生额外的成本。</p><p>&nbsp;</p><p>其次，在代理维护（停机）时，直接从副本获取消息的消费者可能会遇到代理不可用的情况，因此，它们应该等待/重试，直到同一AZ中的代理恢复在线。最后，团队观察到，代理的负载与跨AZ的消费者数量有关。这意味着，消费者的均匀分布对于确保代理的负载平衡至关重要。</p><p>&nbsp;</p><p>原文链接：</p><p><a href=\"https://www.infoq.com/news/2023/07/grab-apache-kafka-aws-cost/\">https://www.infoq.com/news/2023/07/grab-apache-kafka-aws-cost/</a>\"</p><p></p><p>相关阅读：</p><p><a href=\"https://www.infoq.cn/article/ZHFZHsctlAhN8Ai9wdpo\">Cloudflare的Kafka之旅：万亿级消息处理实践</a>\"</p><p><a href=\"https://www.infoq.cn/article/CpfvECIb5gWdditBBYy7\">使用Strimzi提高Kafka集群的安全性</a>\"</p><p></p>",
    "publish_time": "2023-09-07 08:00:00",
    "source": {
      "name": "infoq_recommend",
      "desc": "InfoQ推荐",
      "icon": "https://raw.githubusercontent.com/maguowei/today/master/imgs/icon/infoq.png"
    }
  }
]