[
  {
    "title": "Airbnb引入HTTP Streaming，网页性能升级",
    "url": "https://www.infoq.cn/article/ahPypBYIFOQKd2az4jNb",
    "summary": "<p>Airbnb通过<a href=\"https://medium.com/airbnb-engineering/improving-performance-with-http-streaming-ba9e72c66408?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">引入HTTP Streaming</a>\"来提升网站的页面加载性能。他们将测试的每个页面（包括主页）的首次内容绘制（<a href=\"https://web.dev/fcp/?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">First Contentful Paint</a>\"，FCP）时间降低了大约100毫秒。他们还最小化了后端慢查询对加载时间的影响。</p><p></p><p>Airbnb一直在尝试进行可能的改进，以便尽可能快地向网站用户呈现内容。他们发现，只在完全渲染后才发送页面主体并不能提供最佳的用户体验，特别是当页面主体内容依赖后端查询时。此外，网页通常还需要许多额外的资源，如CSS文件和外部JavaScript文件，浏览器需要下载这些文件，以便正确地向用户显示内容。这些依赖关系经常导致资源请求发生级联，这可以在网络序列视图中看出来，比如Chrome的<a href=\"https://developer.chrome.com/docs/devtools/network/reference/#waterfall?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">Waterfall</a>\"。</p><p></p><p><img src=\"https://static001.geekbang.org/infoq/77/7790569125355c96c193e255ab04e6b6.webp\" /></p><p></p><p>图片来源：<a href=\"https://medium.com/airbnb-engineering/improving-performance-with-http-streaming-ba9e72c66408?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">https://medium.com/airbnb-engineering/improving-performance-with-http-streaming-ba9e72c66408</a>\"</p><p></p><p>一种允许浏览器更早下载外部资源的常见做法是将所有引用它们的标记放在HTML页面头部的标签中。浏览器在读取标签时会下载外部资源。通常，这只会在整个HTML页面被传输后才会发生，如果页面内容依赖了缓慢的后端查询，则可能需要一些时间。</p><p></p><p>尽早冲刷（<a href=\"https://www.stevesouders.com/blog/2009/05/18/flushing-the-document-early/?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">Early Flush</a>\"）是一种利用HTTP Streaming技术让浏览器可以更早地加载外部资源的技术。它需要将HTML页面分成两个部分，并使用<a href=\"https://en.wikipedia.org/wiki/Chunked_transfer_encoding?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">分块传输编码</a>\"分别发送它们。在接收并解析了只包含HTML页面开头部分的初始块后，浏览器就可以开始下载外部资源。</p><p></p><p>尽管尽早冲刷并不是什么新技术，但也并没有被广泛使用，因为它需要渲染和发送不完整的HTML页面（有些标签没有关闭）。Airbnb使用<a href=\"https://expressjs.com/?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">基于Express的NodeJS服务器</a>\"来渲染<a href=\"https://react.dev/?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">React</a>\"开发的网页，并将之前用于渲染整个HTML页面的单个React组件重新设计拆分为三个单独的组件。</p><p></p><p>尽早冲刷技术有助于优化CSS和JavaScript资源的Waterfall指标，但并不会降低渲染页面主体的延迟。使用现代Web应用程序框架可以在客户端或服务器端渲染内容（<a href=\"https://web.dev/rendering-on-the-web/?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">服务器端渲染</a>\"）并分别获取数据，但这需要额外的网络请求。</p><p></p><p>Airbnb的Streaming处理方法经过了改进，他们引入了第三个块（他们称之为延迟数据块），其中包含了页面所需的数据。他们使用<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">MutationObserver</a>\"来检测延迟的数据何时被加载，并将数据注入到应用程序网络数据存储中，从而避免了额外的网络请求。</p><p></p><p></p><p><img src=\"https://static001.geekbang.org/infoq/13/13c0db252bbf01df45e10ba3a96d3c32.webp\" /></p><p></p><p>服务器端渲染（SSR）和客户端数据获取并行执行</p><p></p><p>图片来源：<a href=\"https://medium.com/airbnb-engineering/improving-performance-with-http-streaming-ba9e72c66408?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">https://medium.com/airbnb-engineering/improving-performance-with-http-streaming-ba9e72c66408</a>\"</p><p></p><p>Airbnb必须解决一些问题才能在他们的技术栈中启用HTTP Streaming。他们关闭了<a href=\"https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/#x-accel-buffering?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">NGINX中的响应缓冲</a>\"和<a href=\"https://www.haproxy.com/documentation/hapee/latest/onepage/#4.2-option%20http-no-delay?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">haproxy负载均衡器中的Nagle算法</a>\"，允许块响应数据可以不经修改地到达浏览器。</p><p></p><p>Airbnb软件工程师<a href=\"https://www.linkedin.com/in/victorhlin/?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">Victor Lin</a>\"总结了他们在这方面的经验，以及一个不断增长的支持HTTP Streaming的生态系统：</p><p></p><p></p><blockquote>虽然这个过程充满了挑战，但我们发现，调整现有的React应用程序来支持Streaming是非常可行和健壮的，尽管最初并不是为了它而设计的。我们也很高兴看到更广泛的前端生态系统朝着优先化Streaming的方向发展——从<a href=\"https://graphql.org/blog/2020-12-08-improving-latency-with-defer-and-stream-directives/?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">GraphQL的@defer和@stream</a>\"到<a href=\"https://nextjs.org/docs/advanced-features/react-18/streaming?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">Next.js的Streaming SSR</a>\"。</blockquote><p></p><p></p><p></p><p>原文链接：</p><p><a href=\"https://www.infoq.com/news/2023/06/airbnb-web-http-streaming/?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2ODkzMDQyNTksImZpbGVHVUlEIjoiSHlnd3pJdE9FSXdySno5VSIsImlhdCI6MTY4OTMwMzk1OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjo2MjMyOH0.7B7q8ezZimAjrp-j13lGjjWsy29TGLGfcioKPJDLu_4\">https://www.infoq.com/news/2023/06/airbnb-web-http-streaming/</a>\"</p><p></p><p>相关阅读：</p><p><a href=\"https://www.infoq.cn/article/hPFqXYhRPqjOh6CdHuYR\">AirBnb开源动画引擎Lottie：采用Core Animation提高性能</a>\"</p><p><a href=\"https://www.infoq.cn/article/X16w5IIdYwYPO38vF58o\">Airbnb的统一支付数据读取流程</a>\"</p>",
    "publish_time": "2023-07-19 08:00:00",
    "source": {
      "name": "infoq_recommend",
      "desc": "InfoQ推荐",
      "icon": "https://raw.githubusercontent.com/maguowei/today/master/imgs/icon/infoq.png"
    }
  }
]